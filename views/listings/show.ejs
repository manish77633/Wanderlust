<% layout("layouts/boilerplate") %>

  <body>
    <div class="container my-5 d-flex justify-content-center">
      <div class="row" style="width: 90%;">
        <!-- Left Side: Big Image -->
        <div class="col-md-5 " style="width: 55%; padding-left: 2rem;">
          <img src="<%= listing.image.url %>" alt="<%= listing.title %>" class="img-fluid rounded shadow"
            style="height: 400px; width: 100%; object-fit: cover;">
        </div>

        <!-- Right Side: Details -->
        <div class="col-md-6 d-flex flex-column justify-content-between" style="width: 40%; padding-left: 3rem;">
          <div>
            <!-- <h2 class="mb-3">
              Owner : <%= listing.owner.username %>
            </h2> -->
            <h2 class="mb-3">
              <%= listing.title %>
            </h2>
            <p class="text-muted">
              <%= listing.description %>
            </p>
            <h4 class="text-success mb-3">&#8377; <%= listing.price.toLocaleString("en-IN") %>
            </h4>
            <p><b>Location:</b>
              <%= listing.location %>
            </p>
            <p><b>Country:</b>
              <%= listing.country %>
            </p>
          </div>

          <!-- Buttons -->
          <% if(curuser && listing.owner && curuser._id.equals(listing.owner._id)) { %>
            <div class="mt-4 d-flex gap-3">
              <a href="/listings/<%= listing._id %>/edit" class="btn btn-primary px-4">‚úèÔ∏è Edit</a>
              <form method="POST" action="/listings/<%= listing._id %>?_method=DELETE">
                <button type="submit" class="btn btn-danger px-4">üóëÔ∏è Delete</button>
              </form>
            </div>
            <% } %>
        </div>
      </div>
    </div>
    <!-- Rating & Comment Section -->

    <% if(curuser){ %>
    <div class="review-section mt-5 p-4 border rounded shadow-sm bg-light" >
      <h4 class="text-center mb-4 text-primary fw-bold">‚≠ê Rate and Comment ‚≠ê</h4>
      <form action="/listings/<%= listing._id %>/reviews" method="POST" class="needs-validation" novalidate>
        <!-- Star Rating -->
        <div class="text-center mb-3">
          <div class="rating-stars" id="ratingStars">
            <input type="radio" name="review[rating]" id="star5" value="5">
            <label for="star5" title="5 stars">‚≠ê</label>

            <input type="radio" name="review[rating]" id="star4" value="4">
            <label for="star4" title="4 stars">‚≠ê</label>

            <input type="radio" name="review[rating]" id="star3" value="3">
            <label for="star3" title="3 stars">‚≠ê</label>

            <input type="radio" name="review[rating]" id="star2" value="2">
            <label for="star2" title="2 stars">‚≠ê</label>

            <input type="radio" name="review[rating]" id="star1" value="1">
            <label for="star1" title="1 star">‚≠ê</label>
          </div>
          <div class="invalid-feedback text-center">
            Please select a rating!
          </div>
        </div>

        <!-- Comment Box -->
        <div class="mb-3" style="padding: 0rem 3rem 0rem 3rem;">
          <textarea class="form-control shadow-sm"  rows="3" placeholder="Write your comment here..."
            name="review[comment]" required></textarea>
          <div class="invalid-feedback">Please provide a comment!</div>
        </div>

        <!-- Submit Button -->
        <div class="text-center">
          <button type="submit" class="btn btn-success px-4 py-2 rounded-pill shadow">
            Submit Review üí¨
          </button>
        </div>
      </form>
    </div>

    <% } %>

    <!-- Reviews Display -->
    <div class="reviews-display mt-5 mb-5">
      <h4 class="fw-bold mb-4 text-center">üí¨ All Reviews</h4>

      <% if(listing.reviews && listing.reviews.length> 0) { %>
        <div class="review-card-container">
          <% listing.reviews.forEach(review=> { %>
            <div class="review-card">
              <h6 class="review-author">@<%= review.author.username%></h6>
              <p class="review-rating">
                <% for(let i=0; i<review.rating; i++){ %>‚≠ê<% } %>
                    <% for(let i=review.rating; i<5; i++){ %>‚òÜ<% } %>
              </p>
              <p class="review-comment">
                <%= review.comment %>
              </p>
              <small class="review-date">
                <%= new Date(review.createdAt).toLocaleDateString("en-IN", {day:'numeric', month:'short',
                  year:'numeric'}) %>
              </small>

              <!-- Delete Button Overlay -->
              <form method="POST" action="/listings/<%= listing._id %>/reviews/<%= review._id %>?_method=DELETE"
                class="position-absolute top-0 end-0 m-2">
                <button type="submit" class="btn btn-sm btn-danger">
                  Delete
                </button>
              </form>
            </div>
            <% }) %>
        </div>
        <% } else { %>
          <p class="text-muted text-center">No reviews yet. Be the first to review!</p>
          <% } %>

    </div>


 

 <!-- Map Section -->
<div class="mt-4 text-center">
  <h5>Location on Map</h5>
  <div 
    id="listing-map"
    style="width: 80%; height: 400px; margin: 0 auto; border-radius: 10px;"
    data-lat="<%= listing.lat %>"
    data-lon="<%= listing.lon %>"
    data-label="<%= listing.location + ', ' + listing.country %>">
  </div>
</div>

</div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  integrity="sha256-o9N1j8k5k6b0b0YQF4Yf4q7s9LQo2S7c3q6Yk0CwIcM=" crossorigin=""></script>

<!-- Custom Map Script -->
<script src="/js/map.js"></script>


  </body>